jobs:
- job: linux
  displayName: Linux
  pool:
    vmImage: 'ubuntu-latest'
  strategy:
    matrix:
      python3.6:
        python.version: '3.6'
      python3.7:
        python.version: '3.7'

  variables:
    CONDA_ENV_NAME: "pyomicron"
    CONDA_PKGS_DIRS: $(Pipeline.Workspace)/.conda/pkgs

  steps:
  - task: Cache@2
    inputs:
      key: 'conda | "$(Agent.OS)" | "python$(python.version)"'
      path: $(CONDA_PKGS_DIRS)
      restoreKeys: |
        conda | "$(Agent.OS)"
    displayName: Cache Conda packages

  - bash: |
      set -ex
      echo "##vso[task.prependpath]$CONDA/bin"
      conda config --set always_yes yes
      conda config --prepend channels conda-forge
    displayName: Configure Conda

  - bash: |
      set -ex
      conda create --yes --quiet --name ${CONDA_ENV_NAME} python=${PYTHON_VERSION}
      conda env update --quiet --name ${CONDA_ENV_NAME} --file=environment.yml
      conda install --yes --quiet --name ${CONDA_ENV_NAME} pytest-azurepipelines
    displayName: Create conda environment

  - bash: |
      source activate pyomicron
      set -ex
      python -m pip install --editable .
    displayName: 'Install pyomicron'

  - bash: |
      source activate pyomicron
      set -ex
      python -m coverage run -m pytest --pyargs omicron --junit-xml=junit-results.xml
      python -m coverage run -a $(which omicron-hdf5-merge) --help
      python -m coverage run -a $(which omicron-print) --help
      python -m coverage run -a $(which omicron-process) --help
      python -m coverage run -a $(which omicron-root-merge) --help
      python -m coverage run -a $(which omicron-status) --help
    displayName: 'Run automated tests'

  - task: PublishTestResults@2
    inputs:
      testResultsFiles: 'junit*.xml'
    condition: succeededOrFailed()
    displayName: 'Upload test results'

  - bash: |
      source activate pyomicron
      set -ex
      conda install --yes --quiet --name ${CONDA_ENV_NAME} codecov
      python -m codecov --flags $(uname) python${PYTHON_VERSION/./}
    displayName: 'Upload coverage to codecov.io'
